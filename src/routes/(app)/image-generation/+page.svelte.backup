<script>
	import { onMount, getContext } from 'svelte';
	import { toast } from 'svelte-sonner';
	import { user } from '$lib/stores';
	import Spinner from '$lib/components/common/Spinner.svelte';
	import Plus from '$lib/components/icons/Plus.svelte';
	import Search from '$lib/components/icons/Search.svelte';
	import { 
		generateImageWithPolling, 
		getUserTasks, 
		getMidJourneyConfig,
		getUserCredits,
		executeActionWithPolling,
		fileToBase64,
		GENERATION_MODE,
		TASK_STATUS,
		ASPECT_RATIOS,
		MJ_VERSIONS,
		REFERENCE_TYPES,
		ACTION_TYPES
	} from '$lib/apis/midjourney.js';

	const i18n = getContext('i18n');

	let loaded = false;
	let query = '';
	let generating = false;
	let prompt = '';
	let negativePrompt = '';
	let selectedModel = 'midjourney';
	let selectedMode = 'fast';
	let imageSize = '1:1';
	let generatedImages = [];
	let userCredits = 0; // ç”¨æˆ·vè±†ä½™é¢
	let midJourneyConfig = null;
	let currentTask = null;
	
	// é«˜çº§å‚æ•°
	let showAdvancedOptions = false;
	let chaos = null;
	let stylize = null;
	let seed = null;
	let selectedVersion = null;
	let quality = 1.0;
	let weird = null;
	let tileMode = false;
	
	// å‚è€ƒå›¾ç‰‡
	let referenceImages = [];
	let styleReferenceImages = [];
	let fileInputRef;
	let styleFileInputRef;
	
	// åŠ¨ä½œæŒ‰é’®çŠ¶æ€
	let executingAction = false;
	let selectedImageForAction = null;
	
	// å›¾ç‰‡é¢„è§ˆçŠ¶æ€
	let showImageModal = false;
	let previewImage = null;

	// å›¾åƒç”Ÿæˆå†å² - åªæ˜¾ç¤ºçœŸå®ç”Ÿæˆçš„å›¾ç‰‡
	let imageHistory = [];

	let filteredImages = imageHistory;

	$: {
		filteredImages = query 
			? imageHistory.filter(img => 
				img.prompt.toLowerCase().includes(query.toLowerCase()) ||
				img.model.toLowerCase().includes(query.toLowerCase())
			)
			: imageHistory;
	}

	// åŠ è½½MidJourneyé…ç½®
	const loadMidJourneyConfig = async () => {
		if (!$user?.token) return;
		
		try {
			midJourneyConfig = await getMidJourneyConfig($user.token);
			console.log('MidJourneyé…ç½®åŠ è½½æˆåŠŸ, æœåŠ¡çŠ¶æ€:', midJourneyConfig?.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨');
		} catch (error) {
			console.error('åŠ è½½MidJourneyé…ç½®å¤±è´¥:', error);
		}
	};

	// åŠ è½½ç”¨æˆ·vè±†ä½™é¢
	const loadUserCredits = async () => {
		if (!$user?.token) return;
		
		try {
			const creditsData = await getUserCredits($user.token);
			userCredits = creditsData.credits || 0;
			console.log('ç”¨æˆ·vè±†ä½™é¢åŠ è½½æˆåŠŸ:', userCredits);
		} catch (error) {
			console.error('åŠ è½½ç”¨æˆ·vè±†ä½™é¢å¤±è´¥:', error);
			// å¦‚æœæ— æ³•è·å–ä½™é¢ï¼Œè®¾ç½®ä¸º0é¿å…è¯¯å¯¼
			userCredits = 0;
		}
	};

	// åŠ è½½ç”¨æˆ·ä»»åŠ¡å†å²
	const loadUserTasks = async () => {
		if (!$user?.token) return;
		
		try {
			const response = await getUserTasks($user.token);
			const tasks = response.tasks || [];
			
			// å°†å·²å®Œæˆçš„ä»»åŠ¡è½¬æ¢ä¸ºå›¾åƒå†å²
			const completedTasks = tasks
				.filter(task => task.status === TASK_STATUS.COMPLETED && task.image_url)
				.map(task => ({
					id: task.task_id,
					prompt: task.prompt,
					image: task.image_url,
					timestamp: task.completed_at ? new Date(task.completed_at * 1000) : new Date(),
					model: `MidJourney (${task.mode})`,
					task_id: task.task_id,
					actions: task.actions || [],
					seed: task.seed,
					final_prompt: task.final_prompt,
					aspect_ratio: task.aspect_ratio || '1:1',
					status: 'completed', // å·²å®Œæˆä»»åŠ¡çš„çŠ¶æ€
					progress: 100,
					message: 'å›¾åƒç”Ÿæˆå®Œæˆ'
				}));
			
			imageHistory = [...completedTasks, ...imageHistory];
			if (completedTasks.length > 0) {
				console.log('åŠ è½½äº†', completedTasks.length, 'ä¸ªå†å²ä»»åŠ¡');
			} else {
				console.log('æ²¡æœ‰æ‰¾åˆ°å†å²ä»»åŠ¡ - å¯èƒ½æ˜¯é¦–æ¬¡ä½¿ç”¨æˆ–åç«¯å·²é‡å¯');
			}
		} catch (error) {
			console.error('åŠ è½½ç”¨æˆ·ä»»åŠ¡å¤±è´¥:', error);
		}
	};

	// ç”Ÿæˆå›¾åƒï¼ˆçœŸå®APIè°ƒç”¨ï¼‰
	const generateImage = async () => {
		if (!prompt.trim()) {
			toast.error('è¯·è¾“å…¥å›¾åƒæè¿°');
			return;
		}

		if (!$user?.token) {
			toast.error('è¯·å…ˆç™»å½•');
			return;
		}

		// æ£€æŸ¥MidJourneyæ˜¯å¦å¯ç”¨
		if (!midJourneyConfig?.enabled) {
			toast.error('MidJourneyæœåŠ¡æœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜é…ç½®');
			return;
		}

		// æ£€æŸ¥ç§¯åˆ†
		let requiredCredits;
		if (selectedMode === 'fast') {
			requiredCredits = midJourneyConfig?.fast_credits || 10;
		} else if (selectedMode === 'relax') {
			requiredCredits = midJourneyConfig?.relax_credits || 5;
		} else if (selectedMode === 'turbo') {
			requiredCredits = midJourneyConfig?.turbo_credits || 15;
		} else {
			requiredCredits = 10; // é»˜è®¤fastæ¨¡å¼ç§¯åˆ†
		}
			
		if (userCredits < requiredCredits) {
			toast.error(`vè±†ä½™é¢ä¸è¶³ï¼Œéœ€è¦${requiredCredits}vè±†ï¼Œå½“å‰ä½™é¢ï¼š${userCredits.toFixed(2)}vè±†`);
			return;
		}

		generating = true;
		currentTask = null;
		
		// ç”Ÿæˆä¸´æ—¶ä»»åŠ¡IDç”¨äºå‰ç«¯æ˜¾ç¤º
		const tempTaskId = 'temp_' + Date.now();
		
		try {
			// æ„å»ºè¯·æ±‚
			const request = {
				prompt: prompt.trim(),
				mode: selectedMode,
				aspect_ratio: imageSize,
				negative_prompt: negativePrompt?.trim() || null,
				reference_images: [...referenceImages, ...styleReferenceImages],
				advanced_params: {
					chaos: chaos !== null && chaos !== '' ? parseInt(chaos) : null,
					stylize: stylize !== null && stylize !== '' ? parseInt(stylize) : null,
					seed: seed !== null && seed !== '' ? parseInt(seed) : null,
					version: selectedVersion || null,
					quality: quality !== 1.0 ? quality : null,
					weird: weird !== null && weird !== '' ? parseInt(weird) : null,
					tile: tileMode
				}
			};

			toast.success(`ä»»åŠ¡æäº¤æˆåŠŸï¼æ¶ˆè€—${requiredCredits}ç§¯åˆ†`);
			userCredits -= requiredCredits;
			
			// ç«‹å³åœ¨å†å²ä¸­æ·»åŠ æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
			const pendingImage = {
				id: tempTaskId,
				prompt: prompt.trim(),
				image: null, // æš‚æ— å›¾ç‰‡
				timestamp: new Date(),
				model: `MidJourney (${selectedMode})`,
				task_id: null, // åç«¯ä»»åŠ¡IDç¨åæ›´æ–°
				actions: [],
				seed: null,
				final_prompt: null,
				aspect_ratio: imageSize,
				// è¿›è¡Œä¸­çŠ¶æ€
				status: 'processing',
				progress: 0,
				message: 'ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å¤„ç†'
			};
			
			// æ·»åŠ åˆ°å†å²åˆ—è¡¨é¡¶éƒ¨
			imageHistory = [pendingImage, ...imageHistory];

			// è°ƒç”¨MidJourney API
			const result = await generateImageWithPolling($user.token, request, (status) => {
				// å®æ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€
				currentTask = status;
				console.log('ä»»åŠ¡çŠ¶æ€æ›´æ–°:', status);
				
				// åŒæ—¶æ›´æ–°å†å²è®°å½•ä¸­çš„ä»»åŠ¡çŠ¶æ€
				imageHistory = imageHistory.map(img => {
					if (img.id === tempTaskId) {
						return {
							...img,
							task_id: status.task_id,
							status: status.status,
							progress: status.progress || 0,
							message: status.message || 'æ­£åœ¨ç”Ÿæˆä¸­...',
							image: status.image_url || null // å¦‚æœæœ‰ä¸­é—´å›¾ç‰‡å°±æ˜¾ç¤º
						};
					}
					return img;
				});
				
				if (status.message) {
					toast.info(status.message);
				}
			});

			// ç”Ÿæˆå®Œæˆ - æ›´æ–°å†å²è®°å½•ä¸­çš„ä»»åŠ¡
			imageHistory = imageHistory.map(img => {
				if (img.id === tempTaskId) {
					return {
						...img,
						id: result.task_id, // æ›´æ–°ä¸ºçœŸå®çš„ä»»åŠ¡ID
						task_id: result.task_id,
						image: result.image_url,
						actions: result.actions || [],
						seed: result.seed,
						final_prompt: result.final_prompt,
						status: 'completed',
						progress: 100,
						message: 'å›¾åƒç”Ÿæˆå®Œæˆ'
					};
				}
				return img;
			});
			
			// æ·»åŠ åˆ°ç”Ÿæˆåˆ—è¡¨
			const completedImage = imageHistory.find(img => img.task_id === result.task_id);
			if (completedImage) {
				generatedImages = [completedImage, ...generatedImages];
			}
			
			toast.success('å›¾åƒç”Ÿæˆå®Œæˆï¼');
			
			// æ¸…ç©ºè¾“å…¥
			prompt = '';
			negativePrompt = '';
			currentTask = null;
			// ä¿ç•™é«˜çº§å‚æ•°å’Œå‚è€ƒå›¾ç‰‡ï¼ˆç”¨æˆ·å¯èƒ½æƒ³è¦é‡å¤ä½¿ç”¨ï¼‰
			
		} catch (error) {
			console.error('å›¾åƒç”Ÿæˆå¤±è´¥:', error);
			toast.error('å›¾åƒç”Ÿæˆå¤±è´¥: ' + error.message);
			
			// æ›´æ–°å†å²è®°å½•ä¸­çš„ä»»åŠ¡ä¸ºå¤±è´¥çŠ¶æ€
			imageHistory = imageHistory.map(img => {
				if (img.id === tempTaskId) {
					return {
						...img,
						status: 'failed',
						progress: 0,
						message: 'å›¾åƒç”Ÿæˆå¤±è´¥: ' + error.message
					};
				}
				return img;
			});
			
			// å¤±è´¥æ—¶é€€è¿˜ç§¯åˆ†
			userCredits += requiredCredits;
			currentTask = null;
		} finally {
			generating = false;
		}
	};

	const deleteImage = (id) => {
		imageHistory = imageHistory.filter(img => img.id !== id);
		generatedImages = generatedImages.filter(img => img.id !== id);
		toast.success('å›¾åƒå·²åˆ é™¤');
	};

	const downloadImage = (imageUrl, prompt) => {
		const link = document.createElement('a');
		link.href = imageUrl;
		link.download = `generated-image-${Date.now()}.jpg`;
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
		toast.success('å›¾åƒä¸‹è½½å¼€å§‹');
	};

	// å¤„ç†å‚è€ƒå›¾ç‰‡ä¸Šä¼ 
	const handleReferenceImageUpload = async (event, type = 'reference') => {
		const files = event.target.files;
		if (!files || files.length === 0) return;

		try {
			for (const file of files) {
				// éªŒè¯æ–‡ä»¶ç±»å‹
				if (!file.type.startsWith('image/')) {
					toast.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
					continue;
				}

				// éªŒè¯æ–‡ä»¶å¤§å° (5MBé™åˆ¶)
				if (file.size > 5 * 1024 * 1024) {
					toast.error('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
					continue;
				}

				// è½¬æ¢ä¸ºBase64
				const base64 = await fileToBase64(file);
				
				const imageData = {
					base64: base64,
					weight: 1.0,
					type: type,
					filename: file.name,
					preview: URL.createObjectURL(file)
				};

				if (type === 'reference') {
					if (referenceImages.length >= 3) {
						toast.error('æœ€å¤šåªèƒ½ä¸Šä¼ 3å¼ æ™®é€šå‚è€ƒå›¾');
						break;
					}
					referenceImages = [...referenceImages, imageData];
				} else {
					if (styleReferenceImages.length >= 2) {
						toast.error('æœ€å¤šåªèƒ½ä¸Šä¼ 2å¼ é£æ ¼å‚è€ƒå›¾');
						break;
					}
					styleReferenceImages = [...styleReferenceImages, imageData];
				}
			}
			
			toast.success(`${type === 'reference' ? 'æ™®é€šå‚è€ƒå›¾' : 'é£æ ¼å‚è€ƒå›¾'}ä¸Šä¼ æˆåŠŸ`);
		} catch (error) {
			console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
			toast.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
		}

		// æ¸…ç©ºinput
		event.target.value = '';
	};

	// ç§»é™¤å‚è€ƒå›¾ç‰‡
	const removeReferenceImage = (index, type = 'reference') => {
		if (type === 'reference') {
			// é‡Šæ”¾é¢„è§ˆURL
			URL.revokeObjectURL(referenceImages[index].preview);
			referenceImages = referenceImages.filter((_, i) => i !== index);
		} else {
			URL.revokeObjectURL(styleReferenceImages[index].preview);
			styleReferenceImages = styleReferenceImages.filter((_, i) => i !== index);
		}
		toast.success('å‚è€ƒå›¾ç‰‡å·²ç§»é™¤');
	};

	// æ›´æ–°å‚è€ƒå›¾ç‰‡æƒé‡
	const updateImageWeight = (index, weight, type = 'reference') => {
		const numWeight = parseFloat(weight);
		if (isNaN(numWeight) || numWeight < 0.1 || numWeight > 3.0) {
			toast.error('æƒé‡å€¼å¿…é¡»åœ¨0.1-3.0ä¹‹é—´');
			return;
		}

		if (type === 'reference') {
			referenceImages[index].weight = numWeight;
			referenceImages = [...referenceImages];
		} else {
			styleReferenceImages[index].weight = numWeight;
			styleReferenceImages = [...styleReferenceImages];
		}
	};

	// æ‰§è¡ŒMidJourneyåŠ¨ä½œ (U1-U4, V1-V4ç­‰)
	const executeAction = async (image, action) => {
		if (!$user?.token) {
			toast.error('è¯·å…ˆç™»å½•');
			return;
		}

		if (!image.task_id) {
			toast.error('æ­¤å›¾åƒä¸æ”¯æŒåŠ¨ä½œæ“ä½œ');
			return;
		}

		executingAction = true;
		selectedImageForAction = image.id;

		// ç”Ÿæˆä¸´æ—¶ä»»åŠ¡IDç”¨äºå‰ç«¯æ˜¾ç¤º
		const tempActionTaskId = 'temp_action_' + Date.now();

		try {
			toast.info(`æ­£åœ¨æ‰§è¡Œ${action.label}æ“ä½œ...`);
			
			// ç«‹å³åœ¨å†å²ä¸­æ·»åŠ æ­£åœ¨è¿›è¡Œçš„åŠ¨ä½œä»»åŠ¡
			const pendingActionImage = {
				id: tempActionTaskId,
				prompt: image.prompt + ` (${action.label})`,
				image: null, // æš‚æ— å›¾ç‰‡
				timestamp: new Date(),
				model: image.model + ` - ${action.label}`,
				task_id: null, // åç«¯ä»»åŠ¡IDç¨åæ›´æ–°
				parent_task_id: image.task_id,
				actions: [],
				aspect_ratio: image.aspect_ratio || '1:1',
				// è¿›è¡Œä¸­çŠ¶æ€
				status: 'processing',
				progress: 0,
				message: `æ­£åœ¨æ‰§è¡Œ${action.label}æ“ä½œ`
			};
			
			// æ·»åŠ åˆ°å†å²åˆ—è¡¨é¡¶éƒ¨
			imageHistory = [pendingActionImage, ...imageHistory];
			
			const result = await executeActionWithPolling($user.token, image.task_id, action, (status) => {
				console.log('åŠ¨ä½œæ‰§è¡ŒçŠ¶æ€æ›´æ–°:', status);
				
				// åŒæ—¶æ›´æ–°å†å²è®°å½•ä¸­çš„åŠ¨ä½œä»»åŠ¡çŠ¶æ€
				imageHistory = imageHistory.map(img => {
					if (img.id === tempActionTaskId) {
						return {
							...img,
							task_id: status.task_id,
							status: status.status,
							progress: status.progress || 0,
							message: status.message || `æ­£åœ¨æ‰§è¡Œ${action.label}æ“ä½œ`,
							image: status.image_url || null // å¦‚æœæœ‰ä¸­é—´å›¾ç‰‡å°±æ˜¾ç¤º
						};
					}
					return img;
				});
				
				if (status.message) {
					toast.info(status.message);
				}
			});

			// åŠ¨ä½œå®Œæˆ - æ›´æ–°å†å²è®°å½•ä¸­çš„ä»»åŠ¡
			imageHistory = imageHistory.map(img => {
				if (img.id === tempActionTaskId) {
					return {
						...img,
						id: result.task_id, // æ›´æ–°ä¸ºçœŸå®çš„ä»»åŠ¡ID
						task_id: result.task_id,
						image: result.image_url,
						actions: result.actions || [],
						status: 'completed',
						progress: 100,
						message: `${action.label}æ“ä½œå®Œæˆ`
					};
				}
				return img;
			});
			
			// æ·»åŠ åˆ°ç”Ÿæˆåˆ—è¡¨
			const completedActionImage = imageHistory.find(img => img.task_id === result.task_id);
			if (completedActionImage) {
				generatedImages = [completedActionImage, ...generatedImages];
			}
			
			toast.success(`${action.label}æ“ä½œå®Œæˆï¼`);
			
			// åŠ¨ä½œæˆåŠŸåé‡æ–°åŠ è½½ç”¨æˆ·vè±†ä½™é¢
			await loadUserCredits();

		} catch (error) {
			console.error('åŠ¨ä½œæ‰§è¡Œå¤±è´¥:', error);
			toast.error('åŠ¨ä½œæ‰§è¡Œå¤±è´¥: ' + error.message);
			
			// æ›´æ–°å†å²è®°å½•ä¸­çš„åŠ¨ä½œä»»åŠ¡ä¸ºå¤±è´¥çŠ¶æ€
			imageHistory = imageHistory.map(img => {
				if (img.id === tempActionTaskId) {
					return {
						...img,
						status: 'failed',
						progress: 0,
						message: `${action.label}æ“ä½œå¤±è´¥: ` + error.message
					};
				}
				return img;
			});
			
			// åŠ¨ä½œå¤±è´¥åä¹Ÿé‡æ–°åŠ è½½ç”¨æˆ·vè±†ä½™é¢ï¼ˆåç«¯ä¼šè‡ªåŠ¨é€€æ¬¾ï¼‰
			await loadUserCredits();
		} finally {
			executingAction = false;
			selectedImageForAction = null;
		}
	};

	// ç”Ÿæˆéšæœºç§å­
	const generateRandomSeed = () => {
		seed = Math.floor(Math.random() * 4294967295);
	};

	// è·å–å›¾ç‰‡çš„å®½é«˜æ¯”
	const getImageAspectRatio = (image) => {
		// ä»å›¾ç‰‡çš„aspect_ratioå­—æ®µè·å–æ¯”ä¾‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º1:1
		const aspectRatio = image.aspect_ratio || image.imageSize || '1:1';
		
		// å°†æ¯”ä¾‹å­—ç¬¦ä¸²è½¬æ¢ä¸ºCSS aspect-ratioå€¼
		const [width, height] = aspectRatio.split(':').map(Number);
		return `${width}/${height}`;
	};

	// æ‰“å¼€å›¾ç‰‡é¢„è§ˆ
	const openImagePreview = (image) => {
		previewImage = image;
		showImageModal = true;
	};

	// å…³é—­å›¾ç‰‡é¢„è§ˆ
	const closeImagePreview = () => {
		showImageModal = false;
		previewImage = null;
	};

	// å¤„ç†é”®ç›˜äº‹ä»¶
	const handleKeyDown = (event) => {
		if (event.key === 'Escape' && showImageModal) {
			closeImagePreview();
		}
	};

	onMount(async () => {
		// åŠ è½½MidJourneyé…ç½®ã€ç”¨æˆ·vè±†ä½™é¢å’Œä»»åŠ¡å†å²
		await loadMidJourneyConfig();
		await loadUserCredits();
		await loadUserTasks();
		loaded = true;
	});
</script>

{#if loaded}
	<div class="p-6 max-w-7xl mx-auto">
		<!-- å›¾åƒç”Ÿæˆé¢æ¿ -->
		<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
			<div class="flex items-center gap-3 mb-6">
				<div class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center">
					<svg class="size-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/>
					</svg>
				</div>
				<div class="flex-1">
					<h2 class="text-xl font-semibold text-gray-900 dark:text-white">AIå›¾åƒç”Ÿæˆ</h2>
					<p class="text-sm text-gray-600 dark:text-gray-400">ä½¿ç”¨AIæ¨¡å‹æ ¹æ®æ–‡å­—æè¿°ç”Ÿæˆç²¾ç¾å›¾åƒ</p>
				</div>
				
				<!-- ç§¯åˆ†æ˜¾ç¤º -->
				<div class="flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
					<svg class="size-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
					</svg>
					<span class="text-sm font-medium text-blue-700 dark:text-blue-300">
						vè±†ä½™é¢: {userCredits.toFixed(2)}
					</span>
				</div>
			</div>

			<!-- ç”Ÿæˆå‚æ•° -->
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<!-- å·¦ä¾§ï¼šæç¤ºè¯è¾“å…¥ -->
				<div class="space-y-4">
					<div>
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
							å›¾åƒæè¿° *
						</label>
						<textarea
							bind:value={prompt}
							class="w-full h-32 px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all resize-none"
							placeholder="è¯·æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾åƒï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„å°çŒ«ååœ¨èŠ±å›­é‡Œï¼Œæ•°å­—è‰ºæœ¯é£æ ¼..."
							disabled={generating}
						></textarea>
					</div>

					<div>
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
							è´Ÿé¢æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
						</label>
						<textarea
							bind:value={negativePrompt}
							class="w-full h-20 px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all resize-none"
							placeholder="æè¿°ä½ ä¸å¸Œæœ›å‡ºç°åœ¨å›¾åƒä¸­çš„å†…å®¹..."
							disabled={generating}
						></textarea>
					</div>

					<!-- æ™®é€šå‚è€ƒå›¾ç‰‡ä¸Šä¼  -->
					<div>
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
							æ™®é€šå‚è€ƒå›¾ (æœ€å¤š3å¼ )
						</label>
						<div class="space-y-3">
							<!-- ä¸Šä¼ æŒ‰é’® -->
							<div class="flex items-center gap-2">
								<input
									type="file"
									bind:this={fileInputRef}
									on:change={(e) => handleReferenceImageUpload(e, 'reference')}
									accept="image/*"
									multiple
									class="hidden"
									disabled={generating || referenceImages.length >= 3}
								/>
								<button
									type="button"
									on:click={() => fileInputRef?.click()}
									disabled={generating || referenceImages.length >= 3}
									class="flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-700 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
								>
									<svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
									</svg>
									æ·»åŠ å‚è€ƒå›¾
								</button>
								<span class="text-xs text-gray-500">
									{referenceImages.length}/3
								</span>
							</div>

							<!-- å‚è€ƒå›¾ç‰‡åˆ—è¡¨ -->
							{#if referenceImages.length > 0}
								<div class="grid grid-cols-3 gap-2">
									{#each referenceImages as img, index}
										<div class="relative group">
											<img
												src={img.preview}
												alt="å‚è€ƒå›¾ {index + 1}"
												class="w-full h-20 object-cover rounded-lg border border-gray-200 dark:border-gray-600"
											/>
											<button
												type="button"
												on:click={() => removeReferenceImage(index, 'reference')}
												class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
											>
												<svg class="size-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
												</svg>
											</button>
											<!-- æƒé‡è¾“å…¥ -->
											<div class="mt-1">
												<input
													type="number"
													value={img.weight}
													on:change={(e) => updateImageWeight(index, e.target.value, 'reference')}
													min="0.1"
													max="3.0"
													step="0.1"
													class="w-full px-2 py-1 text-xs border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
													placeholder="æƒé‡"
												/>
											</div>
										</div>
									{/each}
								</div>
							{/if}
						</div>
					</div>

					<!-- é£æ ¼å‚è€ƒå›¾ç‰‡ä¸Šä¼  -->
					<div>
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
							é£æ ¼å‚è€ƒå›¾ (æœ€å¤š2å¼ )
						</label>
						<div class="space-y-3">
							<!-- ä¸Šä¼ æŒ‰é’® -->
							<div class="flex items-center gap-2">
								<input
									type="file"
									bind:this={styleFileInputRef}
									on:change={(e) => handleReferenceImageUpload(e, 'style')}
									accept="image/*"
									multiple
									class="hidden"
									disabled={generating || styleReferenceImages.length >= 2}
								/>
								<button
									type="button"
									on:click={() => styleFileInputRef?.click()}
									disabled={generating || styleReferenceImages.length >= 2}
									class="flex items-center gap-2 px-4 py-2 bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 border border-purple-200 dark:border-purple-700 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
								>
									<svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"/>
									</svg>
									æ·»åŠ é£æ ¼å›¾
								</button>
								<span class="text-xs text-gray-500">
									{styleReferenceImages.length}/2
								</span>
							</div>

							<!-- é£æ ¼å‚è€ƒå›¾ç‰‡åˆ—è¡¨ -->
							{#if styleReferenceImages.length > 0}
								<div class="grid grid-cols-2 gap-2">
									{#each styleReferenceImages as img, index}
										<div class="relative group">
											<img
												src={img.preview}
												alt="é£æ ¼å›¾ {index + 1}"
												class="w-full h-20 object-cover rounded-lg border border-gray-200 dark:border-gray-600"
											/>
											<button
												type="button"
												on:click={() => removeReferenceImage(index, 'style')}
												class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
											>
												<svg class="size-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
												</svg>
											</button>
											<!-- æƒé‡è¾“å…¥ -->
											<div class="mt-1">
												<input
													type="number"
													value={img.weight}
													on:change={(e) => updateImageWeight(index, e.target.value, 'style')}
													min="0.1"
													max="3.0"
													step="0.1"
													class="w-full px-2 py-1 text-xs border border-gray-200 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
													placeholder="æƒé‡"
												/>
											</div>
										</div>
									{/each}
								</div>
							{/if}
						</div>
					</div>
				</div>

				<!-- å³ä¾§ï¼šç”Ÿæˆå‚æ•° -->
				<div class="space-y-4">
					<div class="grid grid-cols-2 gap-4">
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								AIæ¨¡å‹
							</label>
							<select
								bind:value={selectedModel}
								class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
								disabled={generating}
							>
								<option value="midjourney">Midjourney</option>
							</select>
						</div>

						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								ç”Ÿæˆæ¨¡å¼
							</label>
							<select
								bind:value={selectedMode}
								class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
								disabled={generating}
							>
								<option value="fast">Fastæ¨¡å¼ (10vè±†/å¼ )</option>
								<option value="relax">Relaxæ¨¡å¼ (5vè±†/å¼ )</option>
								<option value="turbo">Turboæ¨¡å¼ (15vè±†/å¼ )</option>
							</select>
						</div>
					</div>

					<div class="grid grid-cols-2 gap-4">
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								å›¾åƒæ¯”ä¾‹
							</label>
							<select
								bind:value={imageSize}
								class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
								disabled={generating}
							>
								{#each Object.entries(ASPECT_RATIOS) as [key, value]}
									<option value={key}>{key} {key === '1:1' ? '(æ­£æ–¹å½¢)' : key === '16:9' ? '(å®½å±)' : key === '9:16' ? '(ç«–å±)' : ''}</option>
								{/each}
							</select>
						</div>

						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								æ¨¡å‹ç‰ˆæœ¬
							</label>
							<select
								bind:value={selectedVersion}
								class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
								disabled={generating}
							>
								<option value={null}>é»˜è®¤ç‰ˆæœ¬</option>
								<optgroup label="ğŸ¯ MidJourney (å†™å®é£æ ¼)">
									<option value="5.2">v5.2</option>
									<option value="6">v6</option>
									<option value="6.1">v6.1 (æ¨è)</option>
									<option value="7">v7 (æœ€æ–°)</option>
								</optgroup>
								<optgroup label="ğŸ¨ Niji (åŠ¨æ¼«é£æ ¼)">
									<option value="niji 5">Niji v5</option>
									<option value="niji 6">Niji v6</option>
								</optgroup>
							</select>
						</div>
					</div>

					<!-- é«˜çº§é€‰é¡¹åˆ‡æ¢æŒ‰é’® -->
					<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-xl">
						<div class="flex items-center gap-2">
							<svg class="size-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
							</svg>
							<span class="text-sm font-medium text-gray-700 dark:text-gray-300">é«˜çº§å‚æ•°</span>
						</div>
						<button
							type="button"
							on:click={() => showAdvancedOptions = !showAdvancedOptions}
							class="px-3 py-1 text-xs bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-550 transition-colors"
						>
							{showAdvancedOptions ? 'æ”¶èµ·' : 'å±•å¼€'}
						</button>
					</div>

					<!-- é«˜çº§å‚æ•°é¢æ¿ -->
					{#if showAdvancedOptions}
						<div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600">
							<div class="grid grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										æ··ä¹±ç¨‹åº¦ (0-100)
									</label>
									<input
										type="number"
										bind:value={chaos}
										min="0"
										max="100"
										class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
										placeholder="é»˜è®¤"
										disabled={generating}
									/>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										é£æ ¼åŒ–ç¨‹åº¦ (0-1000)
									</label>
									<input
										type="number"
										bind:value={stylize}
										min="0"
										max="1000"
										class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
										placeholder="é»˜è®¤"
										disabled={generating}
									/>
								</div>
							</div>

							<div class="grid grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										ç§å­å€¼ (Seed)
									</label>
									<div class="flex gap-2">
										<input
											type="number"
											bind:value={seed}
											min="0"
											max="4294967295"
											class="flex-1 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
											placeholder="éšæœº"
											disabled={generating}
										/>
										<button
											type="button"
											on:click={generateRandomSeed}
											class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-xs"
											disabled={generating}
										>
											ğŸ²
										</button>
									</div>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										å›¾åƒè´¨é‡
									</label>
									<select
										bind:value={quality}
										class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
										disabled={generating}
									>
										<option value={0.25}>ä¸€èˆ¬ (--q 0.25)</option>
										<option value={0.5}>æ¸…æ™° (--q 0.5)</option>
										<option value={1}>é«˜æ¸… (--q 1)</option>
										<option value={2}>è¶…é«˜æ¸… (--q 2)</option>
									</select>
								</div>
							</div>

							<div class="grid grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										å¥‡å¼‚ç¨‹åº¦ (0-3000)
									</label>
									<input
										type="number"
										bind:value={weird}
										min="0"
										max="3000"
										class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
										placeholder="é»˜è®¤"
										disabled={generating}
									/>
								</div>
								<div class="flex items-end">
									<label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300">
										<input
											type="checkbox"
											bind:checked={tileMode}
											class="rounded border-gray-300 dark:border-gray-600 text-pink-500 focus:ring-pink-500"
											disabled={generating}
										/>
										å¹³é“ºæ¨¡å¼ (Tile)
									</label>
								</div>
							</div>
						</div>
					{/if}


					<!-- ä»»åŠ¡è¿›åº¦æ˜¾ç¤º -->
					{#if currentTask && generating}
						<div class="w-full p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-700 mb-4">
							<div class="flex items-center justify-between mb-2">
								<span class="text-sm font-medium text-blue-700 dark:text-blue-300">
									{currentTask.message || 'å¤„ç†ä¸­...'}
								</span>
								<span class="text-xs text-blue-600 dark:text-blue-400">
									{currentTask.progress || 0}%
								</span>
							</div>
							<div class="w-full bg-blue-100 dark:bg-blue-800 rounded-full h-2">
								<div 
									class="bg-blue-500 h-2 rounded-full transition-all duration-300"
									style="width: {currentTask.progress || 0}%"
								></div>
							</div>
							<div class="mt-2 text-xs text-blue-600 dark:text-blue-400">
								ä»»åŠ¡ID: {currentTask.task_id}
							</div>
						</div>
					{/if}

					<!-- ç”ŸæˆæŒ‰é’® -->
					<button
						class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white rounded-xl transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed"
						on:click={generateImage}
						disabled={generating || !prompt.trim()}
					>
						{#if generating}
							<Spinner className="size-4" />
							{currentTask?.message || 'ç”Ÿæˆä¸­...'}
						{:else}
							<svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/>
							</svg>
							ç”Ÿæˆå›¾åƒ
						{/if}
					</button>
				</div>
			</div>
		</div>


		<!-- å›¾åƒå†å²åŒºåŸŸ -->
		<div class="flex items-center justify-between mb-6">
			<div class="flex items-center gap-3">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white">ç”Ÿæˆå†å²</h3>
				<span class="px-3 py-1 text-sm font-medium bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 rounded-full">
					{filteredImages.length} å¼ å›¾åƒ
				</span>
			</div>

			<!-- æœç´¢æ¡† -->
			<div class="relative">
				<div class="absolute left-3 top-1/2 transform -translate-y-1/2">
					<Search className="size-4 text-gray-400" />
				</div>
				<input
					class="pl-10 pr-4 py-2 w-64 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all"
					bind:value={query}
					placeholder="æœç´¢å›¾åƒ..."
				/>
			</div>
		</div>

		<!-- å›¾åƒç½‘æ ¼ -->
		{#if filteredImages.length > 0}
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
				{#each filteredImages as image (image.id)}
					<div class="group bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg hover:border-gray-300 dark:hover:border-gray-600 transition-all duration-200">
						<!-- å›¾åƒ -->
						<div class="relative overflow-hidden" style="aspect-ratio: {getImageAspectRatio(image)};">
							{#if image.image}
								<!-- å·²ç”Ÿæˆçš„å›¾åƒ -->
								<img
									src={image.image}
									alt={image.prompt}
									class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
									loading="lazy"
								/>
								
								<!-- æ‚¬åœæ“ä½œ -->
								<div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
									<div class="flex gap-2">
										<button
											class="p-2 bg-blue-500/90 hover:bg-blue-500 text-white rounded-lg transition-colors"
											on:click={() => openImagePreview(image)}
											title="æ”¾å¤§æŸ¥çœ‹"
										>
											<svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
											</svg>
										</button>
										<button
											class="p-2 bg-white/90 hover:bg-white rounded-lg transition-colors"
											on:click={() => downloadImage(image.image, image.prompt)}
											title="ä¸‹è½½å›¾åƒ"
										>
											<svg class="size-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
											</svg>
										</button>
										<button
											class="p-2 bg-red-500/90 hover:bg-red-500 text-white rounded-lg transition-colors"
											on:click={() => deleteImage(image.id)}
											title="åˆ é™¤å›¾åƒ"
										>
											<svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
											</svg>
										</button>
									</div>
								</div>
							{:else}
								<!-- æ­£åœ¨ç”Ÿæˆä¸­çš„å ä½ç¬¦ -->
								<div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex flex-col items-center justify-center">
									{#if image.status === 'processing'}
										<!-- ç”Ÿæˆä¸­åŠ¨ç”» -->
										<div class="mb-4">
											<Spinner className="size-8 text-pink-500" />
										</div>
										<div class="text-center px-4">
											<div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
												æ­£åœ¨ç”Ÿæˆä¸­...
											</div>
											<div class="text-xs text-gray-500 dark:text-gray-400 mb-3">
												{image.message || 'å¤„ç†ä¸­'}
											</div>
											<!-- è¿›åº¦æ¡ -->
											<div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mb-2">
												<div 
													class="bg-gradient-to-r from-pink-500 to-purple-600 h-2 rounded-full transition-all duration-300"
													style="width: {image.progress || 0}%"
												></div>
											</div>
											<div class="text-xs text-gray-500 dark:text-gray-400">
												{image.progress || 0}%
											</div>
										</div>
									{:else if image.status === 'failed'}
										<!-- å¤±è´¥çŠ¶æ€ -->
										<div class="text-center px-4">
											<div class="mb-3">
												<svg class="size-8 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
												</svg>
											</div>
											<div class="text-sm font-medium text-red-600 dark:text-red-400 mb-2">
												ç”Ÿæˆå¤±è´¥
											</div>
											<div class="text-xs text-gray-500 dark:text-gray-400">
												{image.message || 'æœªçŸ¥é”™è¯¯'}
											</div>
										</div>
									{:else}
										<!-- å…¶ä»–çŠ¶æ€ -->
										<div class="text-center px-4">
											<div class="text-sm text-gray-500 dark:text-gray-400">
												{image.message || 'ç­‰å¾…ä¸­...'}
											</div>
										</div>
									{/if}
								</div>
							{/if}
						</div>

						<!-- å›¾åƒä¿¡æ¯ -->
						<div class="p-4">
							<p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-3 leading-relaxed">
								{image.prompt}
							</p>
							
							<!-- ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º -->
							{#if image.status && image.status !== 'completed'}
								<div class="mb-3 p-2 rounded-lg {image.status === 'processing' ? 'bg-blue-50 dark:bg-blue-900/20' : image.status === 'failed' ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-gray-700'}">
									<div class="flex items-center justify-between text-xs">
										<span class="font-medium {image.status === 'processing' ? 'text-blue-600 dark:text-blue-400' : image.status === 'failed' ? 'text-red-600 dark:text-red-400' : 'text-gray-600 dark:text-gray-400'}">
											{image.status === 'processing' ? 'æ­£åœ¨ç”Ÿæˆä¸­' : image.status === 'failed' ? 'ç”Ÿæˆå¤±è´¥' : 'ä»»åŠ¡çŠ¶æ€'}
										</span>
										{#if image.status === 'processing' && image.progress}
											<span class="text-{image.status === 'processing' ? 'blue' : 'gray'}-500">
												{image.progress}%
											</span>
										{/if}
									</div>
									{#if image.message}
										<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
											{image.message}
										</div>
									{/if}
								</div>
							{/if}

							<!-- MidJourneyåŠ¨ä½œæŒ‰é’® - åªåœ¨ä»»åŠ¡å®Œæˆä¸”æœ‰åŠ¨ä½œæŒ‰é’®æ—¶æ˜¾ç¤º -->
							{#if image.actions && image.actions.length > 0 && (image.status === 'completed' || !image.status)}
								<div class="mb-3">
									<div class="text-xs text-gray-500 dark:text-gray-400 mb-2">MidJourney æ“ä½œ:</div>
									<div class="flex flex-wrap gap-1">
										{#each image.actions as action}
											<button
												type="button"
												on:click={() => executeAction(image, action)}
												disabled={executingAction && selectedImageForAction === image.id}
												class="px-2 py-1 text-xs bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-700 rounded hover:from-blue-100 hover:to-indigo-100 dark:hover:from-blue-900/30 dark:hover:to-indigo-900/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1"
												title={action.type}
											>
												{#if action.emoji}
													<span>{action.emoji}</span>
												{/if}
												{action.label}
												{#if executingAction && selectedImageForAction === image.id}
													<svg class="size-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
													</svg>
												{/if}
											</button>
										{/each}
									</div>
								</div>
							{/if}
							
							<!-- ç§å­å€¼æ˜¾ç¤º -->
							{#if image.seed}
								<div class="mb-2 text-xs text-gray-500 dark:text-gray-400">
									<span class="font-medium">ç§å­:</span> {image.seed}
								</div>
							{/if}
							
							<div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
								<span class="px-2 py-1 bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20 text-pink-600 dark:text-pink-400 rounded-md font-medium">
									{image.model}
								</span>
								<span>
									{image.timestamp.toLocaleString('zh-CN', { 
										month: 'short', 
										day: 'numeric', 
										hour: '2-digit', 
										minute: '2-digit' 
									})}
								</span>
							</div>
						</div>
					</div>
				{/each}
			</div>
		{:else}
			<!-- ç©ºçŠ¶æ€ -->
			<div class="text-center py-12">
				<div class="text-6xl mb-4">ğŸ¨</div>
				<h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">è¿˜æ²¡æœ‰ç”Ÿæˆå›¾åƒ</h3>
				<p class="text-gray-500 dark:text-gray-400 mb-4">å¼€å§‹è¾“å…¥æè¿°æ¥ç”Ÿæˆä½ çš„ç¬¬ä¸€å¼ AIå›¾åƒ</p>
			</div>
		{/if}

		<!-- ä½¿ç”¨æç¤º -->
		<div class="text-center text-gray-500 text-xs mt-8 mb-2">
			ğŸ’¡ æç¤ºï¼šè¯¦ç»†çš„æè¿°èƒ½å¸®åŠ©ç”Ÿæˆæ›´ç²¾å‡†çš„å›¾åƒã€‚å°è¯•åŒ…å«é£æ ¼ã€è‰²å½©ã€æ„å›¾ç­‰å…³é”®è¯
		</div>
	</div>
{:else}
	<div class="w-full h-full flex justify-center items-center">
		<Spinner />
	</div>
{/if}

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
{#if showImageModal && previewImage}
	<div 
		class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
		on:click={closeImagePreview}
		on:keydown={handleKeyDown}
		tabindex="-1"
	>
		<div 
			class="relative max-w-[90vw] max-h-[90vh] bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-2xl"
			on:click|stopPropagation
		>
			<!-- å…³é—­æŒ‰é’® -->
			<button
				class="absolute top-4 right-4 z-10 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full transition-colors"
				on:click={closeImagePreview}
				title="å…³é—­ (ESC)"
			>
				<svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
				</svg>
			</button>
			
			<!-- å›¾ç‰‡å®¹å™¨ -->
			<div class="relative">
				<img
					src={previewImage.image}
					alt={previewImage.prompt}
					class="max-w-full max-h-[80vh] object-contain"
					loading="lazy"
				/>
			</div>
			
			<!-- å›¾ç‰‡ä¿¡æ¯ -->
			<div class="p-6 border-t border-gray-200 dark:border-gray-700">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">å›¾ç‰‡è¯¦æƒ…</h3>
				<p class="text-sm text-gray-600 dark:text-gray-400 mb-3 leading-relaxed">
					{previewImage.prompt}
				</p>
				<div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
					<span class="px-2 py-1 bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20 text-pink-600 dark:text-pink-400 rounded-md font-medium">
						{previewImage.model}
					</span>
					<span>
						{previewImage.timestamp.toLocaleString('zh-CN', { 
							year: 'numeric',
							month: 'short', 
							day: 'numeric', 
							hour: '2-digit', 
							minute: '2-digit' 
						})}
					</span>
				</div>
				{#if previewImage.aspect_ratio}
					<div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
						å®½é«˜æ¯”: {previewImage.aspect_ratio}
					</div>
				{/if}
				{#if previewImage.seed}
					<div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
						ç§å­: {previewImage.seed}
					</div>
				{/if}
			</div>
		</div>
	</div>
{/if}

<!-- é”®ç›˜äº‹ä»¶ç›‘å¬ -->
<svelte:window on:keydown={handleKeyDown} />