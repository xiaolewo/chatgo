# æƒé™ç»„ç³»ç»Ÿå‡çº§æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ¬¡å‡çº§å°†æƒé™ç»„ç³»ç»Ÿä» **å•ç»„æ¨¡å¼** å‡çº§ä¸º **å¤šç»„æ¨¡å¼**ï¼Œå…è®¸ç”¨æˆ·åŠ å…¥å¤šä¸ªä¼ä¸šï¼Œå¹¶å®ç°æŒ‰åŠ å…¥æ—¶é—´é¡ºåºçš„æ™ºèƒ½ç§¯åˆ†æ‰£é™¤æœºåˆ¶ã€‚

## ğŸ”„ ä¸»è¦å˜æ›´

### 1. æ•°æ®åº“ç»“æ„å˜æ›´

#### æ–°å¢è¡¨ï¼š`user_group_membership`

- æ”¯æŒç”¨æˆ·ä¸ç»„çš„å¤šå¯¹å¤šå…³ç³»
- è®°å½•åŠ å…¥æ—¶é—´ï¼Œç”¨äºç§¯åˆ†æ‰£é™¤ä¼˜å…ˆçº§æ’åº
- æ”¯æŒè½¯åˆ é™¤ï¼ˆ`is_active` å­—æ®µï¼‰

```sql
CREATE TABLE user_group_membership (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    group_id TEXT NOT NULL,
    joined_at BIGINT NOT NULL,      -- åŠ å…¥æ—¶é—´ï¼ˆå…³é”®å­—æ®µï¼‰
    is_active BOOLEAN DEFAULT TRUE,  -- æ˜¯å¦æ´»è·ƒ
    created_at BIGINT NOT NULL,
    updated_at BIGINT NOT NULL
);
```

### 2. ä¸šåŠ¡é€»è¾‘å˜æ›´

#### ğŸ¯ ç§¯åˆ†æ‰£é™¤é€»è¾‘

**åŸé€»è¾‘**ï¼šç”¨æˆ·åªèƒ½åœ¨ä¸€ä¸ªç»„ï¼Œæ‰£é™¤è¯¥ç»„ç®¡ç†å‘˜ç§¯åˆ†  
**æ–°é€»è¾‘**ï¼šç”¨æˆ·å¯åœ¨å¤šä¸ªç»„ï¼ŒæŒ‰åŠ å…¥æ—¶é—´é¡ºåºæ‰£é™¤ç§¯åˆ†

```
ç”¨æˆ·åŠ å…¥é¡ºåºï¼šä¼ä¸šA (2024-01-01) â†’ ä¼ä¸šB (2024-02-01) â†’ ä¼ä¸šC (2024-03-01)
ç§¯åˆ†æ‰£é™¤ä¼˜å…ˆçº§ï¼šä¼ä¸šAç®¡ç†å‘˜ â†’ ä¼ä¸šBç®¡ç†å‘˜ â†’ ä¼ä¸šCç®¡ç†å‘˜ â†’ ç”¨æˆ·è‡ªå·±
```

#### ğŸ¢ ç”¨æˆ·ç»„å…³ç³»ç®¡ç†

- ç”¨æˆ·å¯ä»¥åŒæ—¶å±äºå¤šä¸ªä¼ä¸š
- é€€å‡ºä¼ä¸šæ—¶ï¼Œè‡ªåŠ¨è°ƒæ•´ç§¯åˆ†æ‰£é™¤é¡ºåº
- ä¿æŒå‘åå…¼å®¹æ€§

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. æ•°æ®åº“è¿ç§»

```
backend/open_webui/migrations/versions/add_user_group_membership.py
```

- åˆ›å»ºæ–°çš„ç”¨æˆ·ç»„å…³ç³»è¡¨
- æ·»åŠ å¿…è¦çš„ç´¢å¼•å’Œçº¦æŸ

### 2. æ¨¡å‹å±‚ä¿®æ”¹

```
backend/open_webui/models/groups.py
```

**æ–°å¢æ–¹æ³•**ï¼š

- `get_user_groups_ordered()` - æŒ‰åŠ å…¥æ—¶é—´è·å–ç”¨æˆ·æ‰€åœ¨ç»„
- `add_user_to_group()` - æ·»åŠ ç”¨æˆ·åˆ°ç»„
- `remove_user_from_group()` - ä»ç»„ä¸­ç§»é™¤ç”¨æˆ·

**ä¿®æ”¹æ–¹æ³•**ï¼š

- `get_user_group()` - ç°åœ¨è¿”å›æœ€æ—©åŠ å…¥çš„ç»„ï¼ˆå‘åå…¼å®¹ï¼‰
- `ensure_user_in_single_group()` - æ”¹ä¸ºç¡®ä¿ç”¨æˆ·åœ¨ç»„å†…ï¼ˆä¸å†é™åˆ¶å•ç»„ï¼‰

### 3. è·¯ç”±å±‚ä¿®æ”¹

```
backend/open_webui/routers/groups.py
```

**æ–°å¢API**ï¼š

- `POST /groups/id/{group_id}/add-user/{user_id}` - æ·»åŠ ç”¨æˆ·åˆ°ç»„
- `POST /groups/id/{group_id}/remove-user/{user_id}` - ä»ç»„ç§»é™¤ç”¨æˆ·
- `GET /groups/user/{user_id}/groups` - è·å–ç”¨æˆ·æ‰€åœ¨ç»„åˆ—è¡¨

**ä¿®æ”¹API**ï¼š

- `GET /groups/admin-credit` - æ”¯æŒå¤šç»„ç§¯åˆ†ä¿¡æ¯å±•ç¤º

### 4. ç§¯åˆ†æ‰£é™¤é€»è¾‘ä¿®æ”¹

```
backend/open_webui/utils/credit/usage.py
```

- ä¿®æ”¹ `CreditDeduct.__exit__()` æ–¹æ³•
- å®ç°æŒ‰åŠ å…¥æ—¶é—´é¡ºåºçš„æ™ºèƒ½ç§¯åˆ†æ‰£é™¤
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 5. æ•°æ®è¿ç§»è„šæœ¬

```
backend/migrate_group_memberships.py
```

- å°†ç°æœ‰ç”¨æˆ·ç»„å…³ç³»è¿ç§»åˆ°æ–°è¡¨
- éªŒè¯è¿ç§»ç»“æœçš„å®Œæ•´æ€§

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd backend
alembic upgrade head
```

### 2. è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬

```bash
cd backend
python migrate_group_memberships.py
```

### 3. é‡å¯åº”ç”¨

```bash
# é‡å¯ OpenWebUI åç«¯æœåŠ¡
```

## ğŸ“– æ–°åŠŸèƒ½ä½¿ç”¨è¯´æ˜

### 1. ç®¡ç†å‘˜æ“ä½œ

#### æ·»åŠ ç”¨æˆ·åˆ°ä¼ä¸š

```bash
curl -X POST "http://localhost:8080/api/v1/groups/id/{group_id}/add-user/{user_id}" \
  -H "Authorization: Bearer admin_token"
```

#### ä»ä¼ä¸šç§»é™¤ç”¨æˆ·

```bash
curl -X POST "http://localhost:8080/api/v1/groups/id/{group_id}/remove-user/{user_id}" \
  -H "Authorization: Bearer admin_token"
```

#### æŸ¥çœ‹ç”¨æˆ·æ‰€åœ¨ä¼ä¸š

```bash
curl -X GET "http://localhost:8080/api/v1/groups/user/{user_id}/groups" \
  -H "Authorization: Bearer admin_token"
```

### 2. ç”¨æˆ·ä½“éªŒ

#### æŸ¥çœ‹ç§¯åˆ†ä¿¡æ¯

```bash
curl -X GET "http://localhost:8080/api/v1/groups/admin-credit" \
  -H "Authorization: Bearer user_token"
```

**è¿”å›ç¤ºä¾‹**ï¼š

```json
{
	"user_credit": 100,
	"admin_credit": 1000,
	"admin_id": "admin_123",
	"admin_name": "ä¼ä¸šç®¡ç†å‘˜",
	"group_id": "group_456",
	"group_name": "ä¼ä¸šA",
	"groups": [
		{
			"id": "group_456",
			"name": "ä¼ä¸šA",
			"admin_id": "admin_123",
			"admin_name": "ä¼ä¸šç®¡ç†å‘˜",
			"admin_credit": 1000
		},
		{
			"id": "group_789",
			"name": "ä¼ä¸šB",
			"admin_id": "admin_456",
			"admin_name": "ä¼ä¸šBç®¡ç†å‘˜",
			"admin_credit": 500
		}
	]
}
```

## ğŸ”„ ç§¯åˆ†æ‰£é™¤ç¤ºä¾‹

### åœºæ™¯æè¿°

- ç”¨æˆ·å°æ˜å±äº 3 ä¸ªä¼ä¸šï¼š
  - ä¼ä¸šAï¼ˆ2024-01-01 åŠ å…¥ï¼Œç®¡ç†å‘˜ç§¯åˆ†ï¼š1000ï¼‰
  - ä¼ä¸šBï¼ˆ2024-02-01 åŠ å…¥ï¼Œç®¡ç†å‘˜ç§¯åˆ†ï¼š500ï¼‰
  - ä¼ä¸šCï¼ˆ2024-03-01 åŠ å…¥ï¼Œç®¡ç†å‘˜ç§¯åˆ†ï¼š200ï¼‰
- å°æ˜è‡ªå·±çš„ç§¯åˆ†ï¼š100
- æœ¬æ¬¡æ¶ˆè´¹ï¼š300 ç§¯åˆ†

### æ‰£é™¤é€»è¾‘

1. **æ£€æŸ¥ä¼ä¸šAç®¡ç†å‘˜**ï¼šç§¯åˆ† 1000 â‰¥ 300 âœ… â†’ æ‰£é™¤ä¼ä¸šAç®¡ç†å‘˜ 300 ç§¯åˆ†
2. å¦‚æœä¼ä¸šAç§¯åˆ†ä¸è¶³ï¼Œæ£€æŸ¥ä¼ä¸šBç®¡ç†å‘˜
3. å¦‚æœä¼ä¸šBç§¯åˆ†ä¸è¶³ï¼Œæ£€æŸ¥ä¼ä¸šCç®¡ç†å‘˜
4. å¦‚æœæ‰€æœ‰ä¼ä¸šç§¯åˆ†éƒ½ä¸è¶³ï¼Œæ‰£é™¤ç”¨æˆ·è‡ªå·±çš„ç§¯åˆ†

### æ—¥å¿—è¾“å‡º

```
[credit_deduct] user: ming_123; actual_payer: admin_a; group: ä¼ä¸šA; tokens: 1000 500; cost: 300; subscription_used: 0; regular_used: 300
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹æ€§

- ç°æœ‰ API ä¿æŒæ­£å¸¸å·¥ä½œ
- ç°æœ‰å•ç»„ç”¨æˆ·æ— éœ€é¢å¤–æ“ä½œ
- `get_user_group()` ä»è¿”å›æœ€æ—©åŠ å…¥çš„ç»„

### 2. æ•°æ®å®‰å…¨

- è½¯åˆ é™¤æœºåˆ¶ï¼Œä¸ä¼šä¸¢å¤±å†å²å…³ç³»æ•°æ®
- è¿ç§»è„šæœ¬åŒ…å«å®Œæ•´æ€§éªŒè¯
- æ”¯æŒå›æ»šæ“ä½œ

### 3. æ€§èƒ½è€ƒè™‘

- æŸ¥è¯¢æŒ‰åŠ å…¥æ—¶é—´æ’åºï¼Œå¯¹å¤§é‡ç»„çš„ç”¨æˆ·æœ‰è½»å¾®æ€§èƒ½å½±å“
- å»ºè®®ä¸ºæ´»è·ƒç”¨æˆ·è®¾ç½®åˆç†çš„ç»„æ•°é‡é™åˆ¶

### 4. æƒé™ç®¡ç†

- æ–°çš„ç”¨æˆ·ç»„ç®¡ç† API éœ€è¦ç®¡ç†å‘˜æƒé™
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç»„ä¿¡æ¯
- ç§¯åˆ†æ‰£é™¤éµå¾ªç°æœ‰çš„å®‰å…¨ç­–ç•¥

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. è¿ç§»å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
python -c "from open_webui.internal.db import get_db; print('æ•°æ®åº“è¿æ¥æ­£å¸¸')"

# é‡æ–°è¿è¡Œè¿ç§»
python migrate_group_memberships.py
```

#### 2. ç§¯åˆ†æ‰£é™¤å¼‚å¸¸

- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£ç¡®åŠ å…¥ç»„
- ç¡®è®¤ç®¡ç†å‘˜ç§¯åˆ†ä½™é¢
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

#### 3. API è®¿é—®å¤±è´¥

- ç¡®è®¤ç”¨æˆ·æƒé™ï¼ˆç®¡ç†å‘˜/æ™®é€šç”¨æˆ·ï¼‰
- æ£€æŸ¥ç»„IDå’Œç”¨æˆ·IDæ˜¯å¦æ­£ç¡®
- éªŒè¯ Bearer Token æœ‰æ•ˆæ€§

## ğŸ“ˆ åç»­è§„åˆ’

### å¯èƒ½çš„å¢å¼ºåŠŸèƒ½

1. **ç»„ä¼˜å…ˆçº§è®¾ç½®** - å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ç§¯åˆ†æ‰£é™¤é¡ºåº
2. **ç§¯åˆ†æ± å…±äº«** - ä¼ä¸šå†…ç§¯åˆ†å…±äº«æœºåˆ¶
3. **ç»„æƒé™ç»†åŒ–** - ä¸åŒç»„çš„ä¸åŒæƒé™çº§åˆ«
4. **æ‰¹é‡æ“ä½œ** - æ‰¹é‡æ·»åŠ /ç§»é™¤ç”¨æˆ·
5. **ç»„ç»Ÿè®¡æŠ¥è¡¨** - ä¼ä¸šç§¯åˆ†ä½¿ç”¨ç»Ÿè®¡

---

_æœ¬æ–‡æ¡£è®°å½•äº†æƒé™ç»„ç³»ç»Ÿä»å•ç»„åˆ°å¤šç»„çš„å®Œæ•´å‡çº§è¿‡ç¨‹ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚_
