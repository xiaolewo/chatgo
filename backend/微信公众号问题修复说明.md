# å¾®ä¿¡å…¬ä¼—å·é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

æ ¹æ®ç”¨æˆ·æä¾›çš„æ—¥å¿—ï¼Œå¾®ä¿¡å…¬ä¼—å·å­˜åœ¨ä»¥ä¸‹ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **æ¬¢è¿æ¶ˆæ¯æ²¡æœ‰å‘é€**ï¼šå½“å·²å…³æ³¨ç”¨æˆ·æ‰«æäºŒç»´ç æ—¶ï¼ˆSCANäº‹ä»¶ï¼‰ï¼Œç³»ç»Ÿæ²¡æœ‰å‘é€æ¬¢è¿æ¶ˆæ¯
2. **ç”¨æˆ·å¤´åƒå’Œæ˜µç§°è·å–ä¸ºç©º**ï¼šä»å¾®ä¿¡APIè·å–çš„ç”¨æˆ·ä¿¡æ¯ä¸­ï¼Œnicknameå’Œheadimgurlå­—æ®µä¸ºç©º

## é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šSCANäº‹ä»¶ç¼ºå°‘æ¬¢è¿æ¶ˆæ¯

ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```
2025-06-25 01:04:09.025 | INFO | open_webui.routers.auths:wechat_follow_event:1205 - å·²å…³æ³¨ç”¨æˆ· o07-E6n_AfYHSAq6qTv78yJPVZOg æ‰«æäº†åœºæ™¯å€¼ b13a1f4d çš„äºŒç»´ç 
```

åŸä»£ç ä¸­ï¼Œåªæœ‰åœ¨ `subscribe` äº‹ä»¶ï¼ˆæ–°ç”¨æˆ·å…³æ³¨ï¼‰æ—¶æ‰å‘é€æ¬¢è¿æ¶ˆæ¯ï¼Œè€Œåœ¨ `SCAN` äº‹ä»¶ï¼ˆå·²å…³æ³¨ç”¨æˆ·æ‰«æäºŒç»´ç ï¼‰æ—¶æ²¡æœ‰å‘é€ã€‚

### é—®é¢˜2ï¼šç”¨æˆ·ä¿¡æ¯ä¸ºç©º

ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```
å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯: {'subscribe': 1, 'openid': 'o07-E6n_AfYHSAq6qTv78yJPVZOg', 'nickname': '', 'sex': 0, 'language': 'zh_CN', 'city': '', 'province': '', 'country': '', 'headimgurl': '', ...}
```

è¿™ä¸ªé—®é¢˜çš„å¯èƒ½åŸå› ï¼š

- ç”¨æˆ·çš„å¾®ä¿¡éšç§è®¾ç½®é™åˆ¶äº†ä¿¡æ¯è·å–
- å…¬ä¼—å·æƒé™ä¸è¶³
- éœ€è¦æ›´å¥½çš„é»˜è®¤å€¼å¤„ç†

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåœ¨SCANäº‹ä»¶ä¸­æ·»åŠ æ¬¢è¿æ¶ˆæ¯å‘é€

**æ–‡ä»¶**: `backend/open_webui/routers/auths.py`

åœ¨SCANäº‹ä»¶å¤„ç†éƒ¨åˆ†æ·»åŠ æ¬¢è¿æ¶ˆæ¯å‘é€é€»è¾‘ï¼š

```python
# å¤„ç†æ‰«æäº‹ä»¶ï¼ˆå·²å…³æ³¨ç”¨æˆ·æ‰«æå¸¦å‚æ•°äºŒç»´ç ï¼‰
elif msg_type == "event" and event == "SCAN":
    scene_id = scene_str
    WeChatFollowService.mark_followed(scene_id, openid)
    log.info(f"å·²å…³æ³¨ç”¨æˆ· {openid} æ‰«æäº†åœºæ™¯å€¼ {scene_id} çš„äºŒç»´ç ")
    log.info(f"å·²æ ‡è®°åœºæ™¯å€¼ {scene_id} ä¸ºå·²å…³æ³¨çŠ¶æ€")

    # å‘é€æ¬¢è¿æ¶ˆæ¯ï¼ˆSCANäº‹ä»¶ä¹Ÿåº”è¯¥å‘é€ï¼‰
    try:
        await WeChatFollowService.send_welcome_message(request, openid)
        log.info(f"æˆåŠŸå‘é€æ¬¢è¿æ¶ˆæ¯ç»™å·²å…³æ³¨ç”¨æˆ· {openid}")
    except Exception as e:
        log.error(f"å‘é€æ¬¢è¿æ¶ˆæ¯å¤±è´¥: {str(e)}")
```

### ä¿®å¤2ï¼šå¢å¼ºç”¨æˆ·ä¿¡æ¯è·å–å’Œé»˜è®¤å€¼å¤„ç†

**æ–‡ä»¶**: `backend/open_webui/routers/auths.py`

#### 2.1 æ”¹è¿› get_wechat_user_info æ–¹æ³•

æ·»åŠ æ›´å¥½çš„æ•°æ®å¤„ç†å’Œé»˜è®¤å€¼ï¼š

```python
# å¤„ç†ç©ºå€¼å’Œé»˜è®¤å€¼
processed_data = {
    "subscribe": user_data.get("subscribe", 1),
    "openid": user_data.get("openid", openid),
    "nickname": user_data.get("nickname", "") or f"å¾®ä¿¡ç”¨æˆ·_{openid[-8:]}",
    "sex": user_data.get("sex", 0),
    "language": user_data.get("language", "zh_CN"),
    "city": user_data.get("city", ""),
    "province": user_data.get("province", ""),
    "country": user_data.get("country", ""),
    "headimgurl": user_data.get("headimgurl", "") or "",
    "subscribe_time": user_data.get("subscribe_time", int(time.time())),
    # ... å…¶ä»–å­—æ®µ
}

# è®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
log.info(f"åŸå§‹å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯: {user_data}")
log.info(f"å¤„ç†åçš„ç”¨æˆ·ä¿¡æ¯: {processed_data}")

# å¦‚æœæ˜µç§°å’Œå¤´åƒéƒ½ä¸ºç©ºï¼Œè®°å½•è­¦å‘Š
if not processed_data["nickname"] or processed_data["nickname"] == f"å¾®ä¿¡ç”¨æˆ·_{openid[-8:]}":
    log.warning(f"ç”¨æˆ· {openid} çš„æ˜µç§°ä¸ºç©ºï¼Œå¯èƒ½æ˜¯éšç§è®¾ç½®é™åˆ¶")
if not processed_data["headimgurl"]:
    log.warning(f"ç”¨æˆ· {openid} çš„å¤´åƒä¸ºç©ºï¼Œå¯èƒ½æ˜¯éšç§è®¾ç½®é™åˆ¶")
```

#### 2.2 æ”¹è¿›ç”¨æˆ·åˆ›å»ºæ—¶çš„é»˜è®¤å€¼å¤„ç†

```python
# ä½¿ç”¨å¾®ä¿¡æ˜µç§°ä½œä¸ºç”¨æˆ·åï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤åç§°
nickname = user_info.get("nickname", "")
if not nickname or nickname == f"å¾®ä¿¡ç”¨æˆ·_{form_data.openid[-8:]}":
    nickname = f"å¾®ä¿¡ç”¨æˆ·_{form_data.openid[-8:]}"

profile_image_url = user_info.get("headimgurl", "")

# å¦‚æœæ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒç”Ÿæˆé€»è¾‘
if not profile_image_url:
    # ç”ŸæˆåŸºäºopenidçš„é»˜è®¤å¤´åƒURL
    import hashlib
    avatar_hash = hashlib.md5(form_data.openid.encode()).hexdigest()
    profile_image_url = f"https://www.gravatar.com/avatar/{avatar_hash}?d=identicon&s=200"
```

#### 2.3 æ”¹è¿›ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶çš„å¤„ç†

```python
# å¤„ç†æ˜µç§°
nickname = user_info.get("nickname", "")
if not nickname or nickname == f"å¾®ä¿¡ç”¨æˆ·_{form_data.openid[-8:]}":
    # å¦‚æœå¾®ä¿¡æ˜µç§°ä¸ºç©ºæˆ–æ˜¯é»˜è®¤ç”Ÿæˆçš„ï¼Œä¿æŒåŸæœ‰æ˜µç§°æˆ–ç”Ÿæˆæ–°çš„
    if user.name and not user.name.startswith("å¾®ä¿¡ç”¨æˆ·_"):
        nickname = user.name  # ä¿æŒåŸæœ‰æ˜µç§°
    else:
        nickname = f"å¾®ä¿¡ç”¨æˆ·_{form_data.openid[-8:]}"

# å¤„ç†å¤´åƒ
profile_image_url = user_info.get("headimgurl", "")
if not profile_image_url:
    # å¦‚æœå¾®ä¿¡å¤´åƒä¸ºç©ºï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰å¤´åƒ
    if user.profile_image_url and not user.profile_image_url.startswith("https://www.gravatar.com/avatar/"):
        profile_image_url = user.profile_image_url  # ä¿æŒåŸæœ‰å¤´åƒ
    else:
        # ç”Ÿæˆé»˜è®¤å¤´åƒ
        import hashlib
        avatar_hash = hashlib.md5(form_data.openid.encode()).hexdigest()
        profile_image_url = f"https://www.gravatar.com/avatar/{avatar_hash}?d=identicon&s=200"
```

## é…ç½®éªŒè¯

ç¡®ä¿ä»¥ä¸‹é…ç½®æ­£ç¡®è®¾ç½®ï¼š

```python
# å¾®ä¿¡å…¬ä¼—å·æ¶ˆæ¯æ¨é€é…ç½®
WECHAT_WELCOME_ENABLED = True  # å¯ç”¨æ¬¢è¿æ¶ˆæ¯
WECHAT_WELCOME_MESSAGE = "ğŸ‰ æ¬¢è¿å…³æ³¨ï¼\n\næ‚¨å·²æˆåŠŸå…³æ³¨æˆ‘ä»¬çš„å…¬ä¼—å·ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨å¾®ä¿¡å¿«é€Ÿç™»å½•æˆ‘ä»¬çš„AIå¹³å°äº†ï¼\n\nâœ¨ åŠŸèƒ½ç‰¹è‰²ï¼š\nâ€¢ å¾®ä¿¡å¿«æ·ç™»å½•\nâ€¢ æ™ºèƒ½AIå¯¹è¯\nâ€¢ å¤šæ¨¡å‹æ”¯æŒ\n\nç‚¹å‡»èœå•æˆ–å‘é€æ¶ˆæ¯å¼€å§‹ä½“éªŒå§ï¼"
WECHAT_AUTO_REPLY_ENABLED = True  # å¯ç”¨è‡ªåŠ¨å›å¤
```

## æµ‹è¯•æ­¥éª¤

1. **æµ‹è¯•æ¬¢è¿æ¶ˆæ¯å‘é€**

   - è®©å·²å…³æ³¨ç”¨æˆ·æ‰«æç™»å½•äºŒç»´ç 
   - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "æˆåŠŸå‘é€æ¬¢è¿æ¶ˆæ¯ç»™å·²å…³æ³¨ç”¨æˆ·" çš„è®°å½•
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯

2. **æµ‹è¯•ç”¨æˆ·ä¿¡æ¯å¤„ç†**

   - æ£€æŸ¥æ—¥å¿—ä¸­çš„ "åŸå§‹å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯" å’Œ "å¤„ç†åçš„ç”¨æˆ·ä¿¡æ¯"
   - éªŒè¯å³ä½¿åŸå§‹ä¿¡æ¯ä¸ºç©ºï¼Œå¤„ç†åçš„ä¿¡æ¯ä¹Ÿæœ‰åˆç†çš„é»˜è®¤å€¼
   - æ£€æŸ¥ç”¨æˆ·ç™»å½•åçš„æ˜µç§°å’Œå¤´åƒæ˜¯å¦æ­£å¸¸æ˜¾ç¤º

3. **æµ‹è¯•é»˜è®¤å¤´åƒç”Ÿæˆ**
   - å½“ç”¨æˆ·å¤´åƒä¸ºç©ºæ—¶ï¼ŒéªŒè¯æ˜¯å¦ç”Ÿæˆäº†åŸºäºopenidçš„é»˜è®¤å¤´åƒ
   - å¤´åƒURLæ ¼å¼åº”ä¸ºï¼š`https://www.gravatar.com/avatar/{hash}?d=identicon&s=200`

## è°ƒè¯•å·¥å…·

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹APIè¿›è¡Œè°ƒè¯•ï¼š

1. **æŸ¥çœ‹å¾®ä¿¡é…ç½®**

   ```
   GET /api/v1/auths/wechat/debug/config
   ```

2. **æµ‹è¯•æ¶ˆæ¯å‘é€**ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
   ```
   POST /api/v1/auths/wechat/test/message
   {
     "openid": "ç”¨æˆ·çš„openid",
     "message": "æµ‹è¯•æ¶ˆæ¯å†…å®¹"
   }
   ```

## é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿï¼š

1. **æ­£å¸¸å‘é€æ¬¢è¿æ¶ˆæ¯**ï¼šæ— è®ºæ˜¯æ–°å…³æ³¨ç”¨æˆ·è¿˜æ˜¯å·²å…³æ³¨ç”¨æˆ·æ‰«æäºŒç»´ç ï¼Œéƒ½ä¼šæ”¶åˆ°æ¬¢è¿æ¶ˆæ¯
2. **ä¼˜é›…å¤„ç†ç©ºä¿¡æ¯**ï¼šå³ä½¿å¾®ä¿¡APIè¿”å›çš„ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºï¼Œç³»ç»Ÿä¹Ÿèƒ½ç”Ÿæˆåˆç†çš„é»˜è®¤æ˜µç§°å’Œå¤´åƒ
3. **è¯¦ç»†çš„æ—¥å¿—è®°å½•**ï¼šæä¾›æ›´å¤šè°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

## æ³¨æ„äº‹é¡¹

1. **å¾®ä¿¡APIé™åˆ¶**ï¼šæŸäº›ç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒå¯èƒ½ç”±äºéšç§è®¾ç½®è€Œæ— æ³•è·å–ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡
2. **å¤´åƒæœåŠ¡**ï¼šé»˜è®¤ä½¿ç”¨GravataræœåŠ¡ç”Ÿæˆå¤´åƒï¼Œç¡®ä¿ç½‘ç»œå¯ä»¥è®¿é—®è¯¥æœåŠ¡
3. **æ¶ˆæ¯å‘é€é¢‘ç‡**ï¼šæ³¨æ„å¾®ä¿¡å…¬ä¼—å·çš„æ¶ˆæ¯å‘é€é¢‘ç‡é™åˆ¶ï¼Œé¿å…è¢«é™åˆ¶å‘é€

## ç›¸å…³æ–‡ä»¶

- `backend/open_webui/routers/auths.py` - ä¸»è¦ä¿®å¤æ–‡ä»¶
- `backend/open_webui/config.py` - é…ç½®æ–‡ä»¶
- æ—¥å¿—æ–‡ä»¶ - ç”¨äºè°ƒè¯•å’ŒéªŒè¯ä¿®å¤æ•ˆæœ
