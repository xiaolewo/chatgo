# 微信公众号问题修复说明

## 问题描述

根据用户提供的日志，微信公众号存在以下两个主要问题：

1. **欢迎消息没有发送**：当已关注用户扫描二维码时（SCAN事件），系统没有发送欢迎消息
2. **用户头像和昵称获取为空**：从微信API获取的用户信息中，nickname和headimgurl字段为空

## 问题分析

### 问题1：SCAN事件缺少欢迎消息

从日志中可以看到：

```
2025-06-25 01:04:09.025 | INFO | open_webui.routers.auths:wechat_follow_event:1205 - 已关注用户 o07-E6n_AfYHSAq6qTv78yJPVZOg 扫描了场景值 b13a1f4d 的二维码
```

原代码中，只有在 `subscribe` 事件（新用户关注）时才发送欢迎消息，而在 `SCAN` 事件（已关注用户扫描二维码）时没有发送。

### 问题2：用户信息为空

从日志中可以看到：

```
微信用户信息: {'subscribe': 1, 'openid': 'o07-E6n_AfYHSAq6qTv78yJPVZOg', 'nickname': '', 'sex': 0, 'language': 'zh_CN', 'city': '', 'province': '', 'country': '', 'headimgurl': '', ...}
```

这个问题的可能原因：

- 用户的微信隐私设置限制了信息获取
- 公众号权限不足
- 需要更好的默认值处理

## 修复方案

### 修复1：在SCAN事件中添加欢迎消息发送

**文件**: `backend/open_webui/routers/auths.py`

在SCAN事件处理部分添加欢迎消息发送逻辑：

```python
# 处理扫描事件（已关注用户扫描带参数二维码）
elif msg_type == "event" and event == "SCAN":
    scene_id = scene_str
    WeChatFollowService.mark_followed(scene_id, openid)
    log.info(f"已关注用户 {openid} 扫描了场景值 {scene_id} 的二维码")
    log.info(f"已标记场景值 {scene_id} 为已关注状态")

    # 发送欢迎消息（SCAN事件也应该发送）
    try:
        await WeChatFollowService.send_welcome_message(request, openid)
        log.info(f"成功发送欢迎消息给已关注用户 {openid}")
    except Exception as e:
        log.error(f"发送欢迎消息失败: {str(e)}")
```

### 修复2：增强用户信息获取和默认值处理

**文件**: `backend/open_webui/routers/auths.py`

#### 2.1 改进 get_wechat_user_info 方法

添加更好的数据处理和默认值：

```python
# 处理空值和默认值
processed_data = {
    "subscribe": user_data.get("subscribe", 1),
    "openid": user_data.get("openid", openid),
    "nickname": user_data.get("nickname", "") or f"微信用户_{openid[-8:]}",
    "sex": user_data.get("sex", 0),
    "language": user_data.get("language", "zh_CN"),
    "city": user_data.get("city", ""),
    "province": user_data.get("province", ""),
    "country": user_data.get("country", ""),
    "headimgurl": user_data.get("headimgurl", "") or "",
    "subscribe_time": user_data.get("subscribe_time", int(time.time())),
    # ... 其他字段
}

# 记录详细的调试信息
log.info(f"原始微信用户信息: {user_data}")
log.info(f"处理后的用户信息: {processed_data}")

# 如果昵称和头像都为空，记录警告
if not processed_data["nickname"] or processed_data["nickname"] == f"微信用户_{openid[-8:]}":
    log.warning(f"用户 {openid} 的昵称为空，可能是隐私设置限制")
if not processed_data["headimgurl"]:
    log.warning(f"用户 {openid} 的头像为空，可能是隐私设置限制")
```

#### 2.2 改进用户创建时的默认值处理

```python
# 使用微信昵称作为用户名，如果为空则使用默认名称
nickname = user_info.get("nickname", "")
if not nickname or nickname == f"微信用户_{form_data.openid[-8:]}":
    nickname = f"微信用户_{form_data.openid[-8:]}"

profile_image_url = user_info.get("headimgurl", "")

# 如果没有头像，使用默认头像生成逻辑
if not profile_image_url:
    # 生成基于openid的默认头像URL
    import hashlib
    avatar_hash = hashlib.md5(form_data.openid.encode()).hexdigest()
    profile_image_url = f"https://www.gravatar.com/avatar/{avatar_hash}?d=identicon&s=200"
```

#### 2.3 改进用户信息更新时的处理

```python
# 处理昵称
nickname = user_info.get("nickname", "")
if not nickname or nickname == f"微信用户_{form_data.openid[-8:]}":
    # 如果微信昵称为空或是默认生成的，保持原有昵称或生成新的
    if user.name and not user.name.startswith("微信用户_"):
        nickname = user.name  # 保持原有昵称
    else:
        nickname = f"微信用户_{form_data.openid[-8:]}"

# 处理头像
profile_image_url = user_info.get("headimgurl", "")
if not profile_image_url:
    # 如果微信头像为空，检查用户是否已有头像
    if user.profile_image_url and not user.profile_image_url.startswith("https://www.gravatar.com/avatar/"):
        profile_image_url = user.profile_image_url  # 保持原有头像
    else:
        # 生成默认头像
        import hashlib
        avatar_hash = hashlib.md5(form_data.openid.encode()).hexdigest()
        profile_image_url = f"https://www.gravatar.com/avatar/{avatar_hash}?d=identicon&s=200"
```

## 配置验证

确保以下配置正确设置：

```python
# 微信公众号消息推送配置
WECHAT_WELCOME_ENABLED = True  # 启用欢迎消息
WECHAT_WELCOME_MESSAGE = "🎉 欢迎关注！\n\n您已成功关注我们的公众号，现在可以使用微信快速登录我们的AI平台了！\n\n✨ 功能特色：\n• 微信快捷登录\n• 智能AI对话\n• 多模型支持\n\n点击菜单或发送消息开始体验吧！"
WECHAT_AUTO_REPLY_ENABLED = True  # 启用自动回复
```

## 测试步骤

1. **测试欢迎消息发送**

   - 让已关注用户扫描登录二维码
   - 检查日志中是否有 "成功发送欢迎消息给已关注用户" 的记录
   - 检查用户是否收到欢迎消息

2. **测试用户信息处理**

   - 检查日志中的 "原始微信用户信息" 和 "处理后的用户信息"
   - 验证即使原始信息为空，处理后的信息也有合理的默认值
   - 检查用户登录后的昵称和头像是否正常显示

3. **测试默认头像生成**
   - 当用户头像为空时，验证是否生成了基于openid的默认头像
   - 头像URL格式应为：`https://www.gravatar.com/avatar/{hash}?d=identicon&s=200`

## 调试工具

可以使用以下API进行调试：

1. **查看微信配置**

   ```
   GET /api/v1/auths/wechat/debug/config
   ```

2. **测试消息发送**（管理员权限）
   ```
   POST /api/v1/auths/wechat/test/message
   {
     "openid": "用户的openid",
     "message": "测试消息内容"
   }
   ```

## 预期效果

修复后，系统应该能够：

1. **正常发送欢迎消息**：无论是新关注用户还是已关注用户扫描二维码，都会收到欢迎消息
2. **优雅处理空信息**：即使微信API返回的用户信息为空，系统也能生成合理的默认昵称和头像
3. **详细的日志记录**：提供更多调试信息，便于排查问题

## 注意事项

1. **微信API限制**：某些用户的昵称和头像可能由于隐私设置而无法获取，这是正常现象
2. **头像服务**：默认使用Gravatar服务生成头像，确保网络可以访问该服务
3. **消息发送频率**：注意微信公众号的消息发送频率限制，避免被限制发送

## 相关文件

- `backend/open_webui/routers/auths.py` - 主要修复文件
- `backend/open_webui/config.py` - 配置文件
- 日志文件 - 用于调试和验证修复效果
